(function(){"use strict";BX.namespace("BX.Main.UF");if(typeof BX.Main.UF.Manager!=="undefined"){return}var e={};BX.Main.UF.Manager=function(){this.mode=this.mode||"";this.ajaxUrl="/bitrix/tools/uf.php"};BX.Main.UF.Manager.getEdit=function(e,n){return BX.Main.UF.EditManager.get(e,n)};BX.Main.UF.Manager.getView=function(e,n){return BX.Main.UF.ViewManager.get(e,n)};BX.Main.UF.Manager.prototype.get=function(e,n){if(!this.mode){this.displayError(["No mode set. Use BX.UF.EditManager or BX.UF.ViewManager"]);return}return this.query(this.mode,{FIELDS:e.FIELDS,FORM:e.FORM||"",CONTEXT:e.CONTEXT||""},n)};BX.Main.UF.Manager.prototype.add=function(e,n){if(!this.mode){this.displayError(["No mode set. Use BX.UF.EditManager or BX.UF.ViewManager"]);return}return this.query(this.mode,{action:"add",FIELDS:e.FIELDS,FORM:e.FORM||""},n)};BX.Main.UF.Manager.prototype.update=function(e,n){if(!this.mode){this.displayError(["No mode set. Use BX.UF.EditManager or BX.UF.ViewManager"]);return}return this.query(this.mode,{action:"update",FIELDS:e.FIELDS,FORM:e.FORM||""},n)};BX.Main.UF.Manager.prototype.delete=function(e,n){if(!this.mode){this.displayError(["No mode set. Use BX.UF.EditManager or BX.UF.ViewManager"]);return}return this.query(this.mode,{action:"delete",FIELDS:e.FIELDS,FORM:e.FORM||""},n)};BX.Main.UF.Manager.prototype.query=function(e,n,t){BX.ajax({dataType:"json",url:this.ajaxUrl,method:"POST",data:this.prepareQuery(e,n),onsuccess:this.queryCallback(t)})};BX.Main.UF.Manager.prototype.prepareQuery=function(e,n){var t=n||{};t.mode=e;t.lang=BX.message("LANGUAGE_ID")||"";t.tpl=BX.message("UF_SITE_TPL")||"";t.tpls=BX.message("UF_SITE_TPL_SIGN")||"";t.sessid=BX.bitrix_sessid();return t};BX.Main.UF.Manager.prototype.queryCallback=function(e){var n=BX.proxy(this.processResult,this);return function(t){n(t,e)}};BX.Main.UF.Manager.prototype.processResult=function(e,n){var t="";if(BX.type.isArray(e.ASSET)){t+=e.ASSET.join("\n")}if(!!e.ERROR){this.displayError(e.ERROR)}return BX.html(null,t).then(function(){if(!!n){n(e.FIELD)}})};BX.Main.UF.Manager.prototype.displayError=function(e){for(var n in e){if(e.hasOwnProperty(n)){console.error(e[n])}}};BX.Main.UF.Manager.prototype.registerField=function(n,t,i){e[n]={FIELD:t,NODE:i}};BX.Main.UF.Manager.prototype.unRegisterField=function(n){if(!!e[n]){delete e[n]}};BX.Main.UF.ViewManager=function(){BX.Main.UF.ViewManager.superclass.constructor.apply(this,arguments);this.mode="view"};BX.extend(BX.Main.UF.ViewManager,BX.Main.UF.Manager);BX.Main.UF.EditManager=function(){BX.Main.UF.EditManager.superclass.constructor.apply(this,arguments);this.mode="edit"};BX.extend(BX.Main.UF.EditManager,BX.Main.UF.Manager);BX.Main.UF.EditManager.prototype.validate=function(n,t){if(n.length>0){var i=[];for(var a=0;a<n.length;a++){var r=BX.Main.UF.Factory.getValue(n[a]);if(r!==null){i.push({ENTITY_ID:e[n[a]].FIELD.ENTITY_ID,FIELD:e[n[a]].FIELD.FIELD,ENTITY_VALUE_ID:e[n[a]].FIELD.ENTITY_VALUE_ID,VALUE:r})}}return this.query(this.mode,{action:"validate",FIELDS:i},t)}else{this.queryCallback(t)({FIELD:[]})}};BX.Main.UF.BaseType=function(){};BX.Main.UF.BaseType.prototype.addRow=function(e,n){var t=n.parentNode.getElementsByTagName("span");if(t&&t.length>0&&t[0]){var i=t[0].parentNode;var a=this.getClone(t[t.length-1],e);if(i===n.parentNode){i.insertBefore(a,n)}else{i.appendChild(a)}}};BX.Main.UF.BaseType.prototype.getClone=function(e,n){var t=e.cloneNode(true);var i=this.findInput(t,n);for(var a=0;a<i.length;a++){i[a].value=""}return t};BX.Main.UF.BaseType.prototype.findInput=function(e,n){return BX.findChildren(e,{tagName:/INPUT|TEXTAREA|SELECT/i,attribute:{name:n}},true)};BX.Main.UF.BaseType.prototype.isEmpty=function(n){var t=e[n].NODE,i=n+(e[n].FIELD.MULTIPLE==="Y"?"[]":"");if(!BX.isNodeInDom(t)){console.error("Node for field "+n+" is already removed from DOM")}var a=this.findInput(t,i);if(a.length<=0){console.error("Unable to find field "+n+" in the registered node")}else{for(var r=0;r<a.length;r++){if(a[r].value!==""){return false}}}return true};BX.Main.UF.BaseType.prototype.getValue=function(n){var t=e[n].NODE,i=n+(e[n].FIELD.MULTIPLE==="Y"?"[]":""),a=e[n].FIELD.MULTIPLE==="Y"?[]:"";if(!BX.isNodeInDom(t)){console.error("Node for field "+n+" is already removed from DOM")}var r=this.findInput(t,i);if(r.length<=0){console.error("Unable to find field "+n+" in the registered node")}else{for(var o=0;o<r.length;o++){if(r[o].tagName==="INPUT"&&(r[o].type==="radio"||r[o].type==="checkbox")&&!r[o].checked){continue}if(e[n].FIELD.MULTIPLE==="Y"){a.push(r[o].value)}else{a=r[o].value;break}}}return a};BX.Main.UF.BaseType.prototype.focus=function(n){var t=e[n].NODE,i=n+(e[n].FIELD.MULTIPLE==="Y"?"[]":"");if(!BX.isNodeInDom(t)){console.error("Node for field "+n+" is already removed from DOM")}var a=this.findInput(t,i);if(a.length>0){BX.focus(a[0])}};BX.Main.UF.TypeBoolean=function(){};BX.extend(BX.Main.UF.TypeBoolean,BX.Main.UF.BaseType);BX.Main.UF.TypeBoolean.USER_TYPE_ID="boolean";BX.Main.UF.TypeBoolean.prototype.isEmpty=function(e){return false};BX.Main.UF.TypeInteger=function(){};BX.extend(BX.Main.UF.TypeInteger,BX.Main.UF.BaseType);BX.Main.UF.TypeInteger.USER_TYPE_ID="integer";BX.Main.UF.TypeDouble=function(){};BX.extend(BX.Main.UF.TypeDouble,BX.Main.UF.BaseType);BX.Main.UF.TypeDouble.USER_TYPE_ID="double";BX.Main.UF.TypeSting=function(){};BX.extend(BX.Main.UF.TypeSting,BX.Main.UF.BaseType);BX.Main.UF.TypeSting.USER_TYPE_ID="string";BX.Main.UF.TypeUrl=function(){};BX.extend(BX.Main.UF.TypeUrl,BX.Main.UF.BaseType);BX.Main.UF.TypeUrl.USER_TYPE_ID="url";BX.Main.UF.TypeStingFormatted=function(){};BX.extend(BX.Main.UF.TypeStingFormatted,BX.Main.UF.TypeSting);BX.Main.UF.TypeStingFormatted.USER_TYPE_ID="string_formatted";BX.Main.UF.TypeEnumeration=function(){};BX.extend(BX.Main.UF.TypeEnumeration,BX.Main.UF.BaseType);BX.Main.UF.TypeEnumeration.USER_TYPE_ID="enumeration";BX.Main.UF.TypeEnumeration.prototype.findInput=function(e,n){var t=BX.Main.UF.TypeEnumeration.superclass.findInput.apply(this,arguments);if(t.length>0){for(var i=0;i<t.length;i++){if(t[i].tagName==="INPUT"&&t[i].type==="hidden"&&t.length>1){delete t[i];break}}}return BX.util.array_values(t)};BX.Main.UF.TypeDate=function(){};BX.extend(BX.Main.UF.TypeDate,BX.Main.UF.BaseType);BX.Main.UF.TypeDate.USER_TYPE_ID="date";BX.Main.UF.TypeDateTime=function(){};BX.extend(BX.Main.UF.TypeDateTime,BX.Main.UF.BaseType);BX.Main.UF.TypeDateTime.USER_TYPE_ID="datetime";BX.Main.UF.TypeFile=function(){};BX.extend(BX.Main.UF.TypeFile,BX.Main.UF.BaseType);BX.Main.UF.TypeFile.USER_TYPE_ID="file";BX.Main.UF.TypeFile.prototype.findInput=function(e,n){var t=BX.Main.UF.TypeFile.superclass.findInput.apply(this,arguments);if(t.length<=0){t=BX.findChildren(e,{tagName:/INPUT/i,attribute:{type:"file",name:/^bxu_files/}},true)}return t};BX.Main.UF.TypeFile.prototype.getValue=function(n){var t=BX.Main.UF.TypeFile.superclass.getValue.apply(this,arguments),i=e[n].NODE,a=[],r;if(e[n].FIELD.MULTIPLE==="Y"){var o=n+"_del[]";if(BX.type.isArray(t)&&t.length>0){a=BX.Main.UF.TypeFile.superclass.findInput.apply(this,[i,o]);for(r=0;r<a.length;r++){var p=BX.util.array_search(a[r].value,t);if(p>=0){t[p]={old_id:a[r].value,del:"Y",tmp_name:""}}}}return BX.util.array_values(t)}else if(t>0){var o=n+"_del";a=BX.Main.UF.TypeFile.superclass.findInput.apply(this,[i,o]);for(r=0;r<a.length;r++){if(t==a[r].value){t={old_id:t,del:"Y",tmp_name:""};break}}return t}};BX.Main.UF.Factory=function(){this.defaultTypeHandler=BX.Main.UF.BaseType;this.typeHandlerList={};this.objectCollection={}};BX.Main.UF.Factory.prototype.setTypeHandler=function(e,n){this.typeHandlerList[e]=n;if(typeof this.objectCollection[e]!=="undefined"){delete this.objectCollection[e]}};BX.Main.UF.Factory.prototype.get=function(e){if(typeof this.objectCollection[e]==="undefined"){this.objectCollection[e]=this.getObject(e)}return this.objectCollection[e]};BX.Main.UF.Factory.prototype.getObject=function(e){return new(this.typeHandlerList[e]||this.defaultTypeHandler)};BX.Main.UF.Factory.prototype.getFieldObject=function(n){if(typeof e[n]==="undefined"){console.error("Field "+n+"is not registered. Use BX.Main.UF.Factory.registerField to register");return null}return this.get(e[n]["FIELD"]["USER_TYPE_ID"])};BX.Main.UF.Factory.prototype.isEmpty=function(n){if(typeof e[n]==="undefined"){console.error("Field "+n+"is not registered. Use BX.Main.UF.Factory.registerField to register");return true}return this.get(e[n]["FIELD"]["USER_TYPE_ID"]).isEmpty(n)};BX.Main.UF.Factory.prototype.getValue=function(n){if(typeof e[n]==="undefined"){console.error("Field "+n+"is not registered. Use BX.Main.UF.Factory.registerField to register");return null}return this.get(e[n]["FIELD"]["USER_TYPE_ID"]).getValue(n)};BX.Main.UF.Factory.prototype.focus=function(n){if(typeof e[n]==="undefined"){console.error("Field "+n+"is not registered. Use BX.Main.UF.Factory.registerField to register")}return this.get(e[n]["FIELD"]["USER_TYPE_ID"]).focus(n)};BX.Main.UF.EditManager=new BX.Main.UF.EditManager;BX.Main.UF.ViewManager=new BX.Main.UF.ViewManager;BX.Main.UF.Factory=new BX.Main.UF.Factory;BX.Main.UF.Factory.setTypeHandler(BX.Main.UF.TypeBoolean.USER_TYPE_ID,BX.Main.UF.TypeBoolean);BX.Main.UF.Factory.setTypeHandler(BX.Main.UF.TypeInteger.USER_TYPE_ID,BX.Main.UF.TypeInteger);BX.Main.UF.Factory.setTypeHandler(BX.Main.UF.TypeDouble.USER_TYPE_ID,BX.Main.UF.TypeDouble);BX.Main.UF.Factory.setTypeHandler(BX.Main.UF.TypeSting.USER_TYPE_ID,BX.Main.UF.TypeSting);BX.Main.UF.Factory.setTypeHandler(BX.Main.UF.TypeStingFormatted.USER_TYPE_ID,BX.Main.UF.TypeStingFormatted);BX.Main.UF.Factory.setTypeHandler(BX.Main.UF.TypeEnumeration.USER_TYPE_ID,BX.Main.UF.TypeEnumeration);BX.Main.UF.Factory.setTypeHandler(BX.Main.UF.TypeFile.USER_TYPE_ID,BX.Main.UF.TypeFile)})();